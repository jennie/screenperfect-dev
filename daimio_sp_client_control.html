<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>Screen Perfect Loves You</title>
  <script type="text/javascript" src="/daimio_composite.js"></script>
  <style>
    .hidden {
      display: none !important;
      visibility: hidden;
    }
  </style>
</head>
<body>
  
  <div id="videos" data-daimio-template="build-video-display">
    {begin video_template | >$video-template | ""}
      <video id="{_key}" class="fullscreen hidden" width="640" height="480" loop="true">
        <source  src="{$control-mode | then $videos.{_key}.urls.control else $videos.{_key}.urls.client}" type="video/webm">
        Your browser does not support the video tag.
      </video>
    {end video_template}
    
    {begin image_template | >$image-template | ""}
      <img src="{$control-mode | then $videos.{_key}.urls.control else $videos.{_key}.urls.client}"
            id="{_key}" class="fullscreen hidden" width="640" height="480">
    {end image_template}
    
    {begin selection | each data $videos}
      { $control-mode 
      | then $videos.{_key}.urls.control 
        else $videos.{_key}.urls.client
        with $false
      | string slice start -3 
      | is in (:ebm :m4v :mov) 
      | if __
        then $video-template 
        else $image-template
        with $false
      | run with {* (:key _key :value _value)} }
    {end selection}
  </div>
  
  <div id="divs" data-daimio-template="show-divs">
    {begin divs | merge data $active-video.spots | if $control-mode then __ else ""}
      <div class="clickable" data-value="{_link}" style="{_css}; position: absolute; background-color:green; opacity: 0.4"></div>
    {end divs}
  </div>

  <script id="control" type="text/daml" class="spaceseeds">
    outer
      
      $game-id 0
      $videos  {}
      $active-video {}
      $control-mode
      
      // NETWORK
      @receive-data   socket-in  game-data
      @request-data   socket-out request-data
      @send-active    socket-out
      @receive-active socket-in

      @init from-js
      @init -> @request-data
      @init -> {__.game | >$game-id}
      
      @mode from-js
      @mode -> {__ | >$control-mode }
      
      changed {__}
      changed-id {__}
      store-video-list 
        {__.videos | >$videos | list keys | __.#1 | tap}
      store-active-video 
        {__ | >id | $videos.{_id} | >$active-video}

      @video-play
      // @receive-data -> {__ | 12341234}
      // TODO: check out this weird bug i made dude
      @receive-data -> store-video-list -> changed-id -> store-active-video -> changed
                                           changed-id -> @video-play

      // DISPLAY 
      build-video-display 

      show-divs
      
      @set-divs  dom-set-html divs
      @set-video dom-set-html videos
      changed -> show-divs -> @set-divs
      store-video-list -> build-video-display -> @set-video
      
      // CLICKS
      @clicky dom-on-click .clickable

      @clicky -> { __ | >in | * (:video _in :game $game-id) } -> @send-active
      @receive-active -> {__ | tap} -> changed-id
      
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    D.import_port_flavour('video-play', {
      dir: 'out',
      outside_exit: function(ship) {
        var cur = document.getElementsByClassName('visible')[0];
        var nxt = document.getElementById(ship);

        if(cur && cur.classList) {
          cur.classList.add('hidden');
          cur.classList.remove('visible'); // for use with selectors
          if(cur.pause)
            cur.pause();
        }

        nxt.classList.add('visible');
        nxt.classList.remove('hidden'); 
        if(nxt.currentTime)
          nxt.currentTime = 0;
        if(nxt.play)
          nxt.play();
      }
    })

    document.addEventListener('DOMContentLoaded', function() {

      D.Etc.socket = io.connect('/')

      var template_els = [].slice.call(document.querySelectorAll('[data-daimio-template]'))
        , templates    = template_els.reduce(function(acc, template) {
                           var name  = template.attributes.getNamedItem('data-daimio-template').value
                           acc[name] = template.innerHTML .replace(/ \| &gt;/g, ' | >') // dumb dumb dumb
                           return acc
                         }, {})

      var seedlikes = Array.prototype.slice.call(
                        document.getElementsByClassName('spaceseeds')
                      ).map(function(node) {
                        return node.text
                      }).join("\n")

      var outerseed = D.make_some_space(seedlikes, templates)
      OuterSpace = new D.Space(outerseed) // published for debug

      // activate init port
      var game_id = window.location.pathname.replace(/\/$/, '').split('/')[1]
      D.send_value_to_js_port(outerseed, 'init', {game: game_id, session: false})

      // activate control mode
      if(window.location.pathname.replace(/\/$/, '').split('/').slice(-1)[0] == 'control')
        D.send_value_to_js_port(outerseed, 'mode', 'control')

    })
  </script>

</body>
</html>