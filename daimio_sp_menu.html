<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>Screen Perfect Menu</title>
  <script type="text/javascript" src="/daimio_composite.js"></script>
</head>
<body>

  <h1>Screen Perfect</h1>
  <h2>Perfection is Magic</h2>
  
  <ul id="game-list" data-daimio-template="show-all-games">
    {begin list | each data $games}
       <li>
         <img src="{_value.videos.#1.urls.client_thumb}" height="100" width="100">
         {_value.name}
         <a href="/{_value._id}/client">client</a>
         <a href="/{_value._id}/control">control</a>
       </li>
    {end list}
  </ul>
  
  <form id="add-game-form">
    <p>
      <label for="name">Name</label>
      <input type="text" name="name" value="" id="name">
    </p>
    <p><input type="submit" name="submit" value="add"></p>
  </form>
  
  
  
  <script id="control" type="text/daml" class="spaceseeds">
    outer
      
      $games {}
      
      show-all-games
      
      @games-data  socket-in  games-data
      @get-games   socket-out get-games
      
      @init from-js
      @init -> @get-games
      
      @set-game-list dom-set-html game-list
      @games-data -> {__ | >$games} -> show-all-games -> @set-game-list
      
      // ADD GAME
      @save-game     socket-out     save-game
      @add-game-form dom-on-submit
      @set-name-val  dom-set-value  name
      
      // make sure we have time to save the new game
      add-game-channel {process sleep for 100 | ""}
      
      @add-game-form -> @save-game
      @add-game-form -> add-game-channel -> @set-name-val
                        add-game-channel -> @get-games
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
  
    document.addEventListener('DOMContentLoaded', function() {

      D.Etc.socket = io.connect('/')

      var template_els = [].slice.call(document.querySelectorAll('[data-daimio-template]'))
        , templates    = template_els.reduce(function(acc, template) {
                           var name = template.attributes.getNamedItem('data-daimio-template').value
                           acc[name] = template.innerHTML.replace(/ \| &gt;/g, ' | >') // dumb dumb dumb
                           return acc
                         }, {})
      
      var seedlikes = [].slice.call(
                        document.getElementsByClassName('spaceseeds')
                      ).map(function(node) {
                        return node.text
                      }).join("\n")
      
      var outerseed = D.make_some_space(seedlikes, templates)
      OuterSpace = new D.Space(outerseed) // published for debug
      
      // activate init port
      D.send_value_to_js_port(outerseed, 'init', 1)
      
    })
  </script>

</body>
</html>