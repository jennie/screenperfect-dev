<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>Screen Perfect Daimio Prototype Admin</title>
  <script type="text/javascript" src="/daimio_composite.js"></script>
</head>
<body>
  <h3>ADMINADMINADMIN!!!!</h3>
  
  <form id="video-form" data-daimio-template="show-video-form" style="float:right;position:relative;">
    <div style="position:relative">
      <img id="video" src="{__.urls.client_thumb}">
      {begin divs | merge data __in.spots}
        <div class="clickable" data-value="{_link}" style="{_css}; position: absolute; background-color:green; opacity: 0.4"></div>
      {end divs}
    </div>
    
    <p>
      <label for="name">Name</label>
      <input type="text" name="name" value="{__.name}" id="name">
    </p>
    <p>
      <label for="client">Client Video URL</label>
      <input type="text" name="client" value="{__.urls.client}" id="client" size="100">
    </p>
    <p>
      <label for="control">Control Video URL</label>
      <input type="text" name="control" value="{__.urls.control}" id="control" size="100">
    </p>
    <p>
      <label for="client_thumb">Client Thumbnail URL</label>
      <input type="text" name="client_thumb" value="{__.urls.client_thumb}" id="client_thumb" size="100">
    </p>
    <p>
      <label for="control_thumb">Control Thumbnail URL</label>
      <input type="text" name="control_thumb" value="{__.urls.control_thumb}" id="control_thumb" size="100">
    </p>
    <p>
      <label for="spots">Spots</label>
      <textarea id="spots" name="spots" width="60" height="3">{__.spots}</textarea>
    </p>
    <p>
      <input type="hidden" name="index" value="{__.key}" id="video_index">
      <input type="submit" value="add">
    </p>
  </form>
  
  <ul id="video-list" data-daimio-template="show-all-videos" style="float:left;position:relative;">
    {begin list | merge data $game.videos}
       <li>
         <a href="" class="video-label" data-value="{_key}">
           <img src="{_urls.client_thumb}" width="100" height="100">
           <strong>
             {_name}
           </strong>
         </a>
       </li>
    {end list}
  </ul>
  
  <script id="control" type="text/daml" class="spaceseeds">
    outer
      
      $game {}
      $active-video {}
      
      // NETWORK
      @game-data  socket-in  game-data
      @get-data   socket-out get-data
      @set-active socket-out
      @get-active socket-in
      
      @init from-js
      @init -> { __ | tap } -> @get-data
      
      @mode from-js
      @mode -> { __ | >$control-mode }
      
      changed {__}
      set-active {__ | >id | $game.videos.{_id} | >$active-video}
      @game-data -> {__ | >$game | 0} -> set-active -> changed
      
      // DISPLAY
      show-all-videos
      
      @set-video-list dom-set-html video-list
      changed -> show-all-videos -> @set-video-list
      
      // SAVE A VIDEO
      @save-game socket-out save-game
      @video-form dom-on-submit

      eat-video-form
        { __ | >raw-info
        | {* (:name  _raw-info.name 
              :spots {_raw-info.spots | list from_json} 
              :urls  {_raw-info | list remove by_key (:name :spots)} )}
        | list poke data $game path (:videos {_raw-info.index | else {$game.videos | count}}) | >$game}
        
      @video-form -> eat-video-form -> changed
                     eat-video-form -> @save-game
      
      // EDIT VIDEO
      show-video-form
        
      @set-video-form dom-set-html video-form
      @video-label    dom-on-click .video-label

      @init -> show-video-form -> @set-video-form
      @video-label -> { __ | >key | $game.videos.{_key} | poke _key path :key } -> show-video-form
      
      // TODO: add / remove spots
      // TODO: alex (jennie on repo); 
      // TODO: whitespace
      // TODO: node eat html dynamically
      // TODO: html/daimio mixed
      // TODO: local machine
      
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
      
      D.Etc.socket = io.connect('/')
      
      var template_els = [].slice.call(document.querySelectorAll('[data-daimio-template]'))
        , templates    = template_els.reduce(function(acc, template) {
                           var name = template.attributes.getNamedItem('data-daimio-template').value
                           acc[name] = template.innerHTML
                           return acc
                         }, {})
                       
      var seedlikes = Array.prototype.slice.call(
                        document.getElementsByClassName('spaceseeds')
                      ).map(function(node) {
                        return node.text
                      }).join("\n")
      
      var outerseed = D.make_some_space(seedlikes, templates)
      OuterSpace = new D.Space(outerseed) // published for debug
      
      // activate init port
      var data = {game: '5275ec64388d57ccb2f87d0e'}
      D.send_value_to_js_port(outerseed, 'init', data)
      
      // activate control mode
      if(window.location.pathname.split('/').slice(-1)[0] == 'control')
        D.send_value_to_js_port(outerseed, 'mode', 'control')
        
    })
  </script>

</body>
</html>