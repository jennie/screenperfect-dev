<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>Screen Perfect Daimio Prototype Admin</title>
  <script type="text/javascript" src="/daimio_composite.js"></script>
  <style>
    .selected {
      background-color: pink;
    }
  </style>
</head>
<body style="display:none">
  <h1 id="header" data-daimio-template="poopoo">
    {$game.name}alsdkjflasdkjfa;lsdjkf
  </h1>
  
  <h1 id="header" data-daimio-template="header">
    {$game.name}
  </h1>
  
  <form id="room-form" data-daimio-template="show-room-form" style="float:right;position:relative;">
    <div style="position:relative">
      <img id="room" src="{__.urls.client_thumb}">
      {begin divs | merge data __in.spots}
        <div id="exit-{_key}" class="clickable" data-value="{_link}" style="{_css}; position: absolute; background-color:green; opacity: 0.4"></div>
      {end divs}
    </div>
    
    <p>
      <label for="name">Name</label>
      <input type="text" name="name" value="{__.name}" id="name">
    </p>
    <p>
      <label for="client">Client Video URL</label>
      <input type="text" name="client" value="{__.urls.client}" id="client" size="100">
    </p>
    <p>
      <label for="control">Control Video URL</label>
      <input type="text" name="control" value="{__.urls.control}" id="control" size="100">
    </p>
    <p>
      <label for="client_thumb">Client Thumbnail URL</label>
      <input type="text" name="client_thumb" value="{__.urls.client_thumb}" id="client_thumb" size="100">
    </p>
    <p>
      <label for="control_thumb">Control Thumbnail URL</label>
      <input type="text" name="control_thumb" value="{__.urls.control_thumb}" id="control_thumb" size="100">
    </p>
    <p>
      <label for="spots">Exits</label>
      <ul>
        {begin exists | each data {__in.spots | list from-json}}
          <li class="exit-listing" data-value="{_key}">
            <p>{_key}: {_value}</p>
          </li>
        {end exists}
      </ul>
      <textarea id="spots" name="spots" width="60" height="3">{__.spots}</textarea>
    </p>
    <p>
      <input type="hidden" name="index" value="{$selected-room-id}" id="room_index">
      <input type="submit" value="Edit room">
    </p>
  </form>
  
  <ul id="room-list" data-daimio-template="show-all-rooms" style="float:left;position:relative;">
    <h2>Rooms</h2>

    {begin list | merge data $game.rooms}
       <li class="{_key | is like $selected-room-id | then :selected else ""}">
         <a href="" class="room-label" data-value="{_key}">
           <img src="{_urls.client_thumb}" width="100" height="100">
           <strong>
             {_name}
           </strong>
         </a>
       </li>
    {end list}
    
    <form id="add-room-form">
      <p>
        <label for="name">Name</label>
        <input type="text" name="name" value="" id="name">
      </p>
      <p><input type="submit" name="submit" value="Add room"></p>
    </form>
    
  </ul>
  
  <script id="control" type="text/daml" class="spaceseeds">
    outer
      
      $game {}
      $selected-room-id -1
      
      // NETWORK
      @game-data    socket-in  game-data
      @request-data socket-out request-data
      
      @init from-js
      @init -> @request-data
      
      changed {__}
      @game-data -> {__ | >$game | 0} -> changed
      
      // DISPLAY
      show-all-rooms
      header
      
      @set-room-list dom-set-html room-list
      @set-header    dom-set-html header
      
      changed -> show-all-rooms -> @set-room-list
      changed -> header         -> @set-header
      
      // SAVE A ROOM
      @save-game socket-out save-game
      @room-form dom-on-submit

      eat-room-form
        { __ | tap | >raw-info
        | * (:name  _raw-info.name 
             :spots {_raw-info.spots | list from_json} 
             :urls  {_raw-info | list remove by_key (:name :spots)} )
        | list poke data $game path (:rooms {_raw-info.index | else {$game.rooms | count}}) | >$game}
        
      @room-form -> eat-room-form -> changed
                    eat-room-form -> @save-game
      
      // SELECT A ROOM
      show-room-form
      room-changer
        { __ | >$selected-room-id}
      selected-room-only
        {$selected-room-id | eq -1 | else "{1 | >@good}" | run}
      
      @change-room   dom-on-click .room-label
      @set-room-form dom-set-html  room-form

      @init -> {"<p>Select a room from the list</p>"} -> @set-room-form
      @change-room -> room-changer -> changed
      changed -> selected-room-only
      selected-room-only.good -> {$game.rooms.{$selected-room-id}} -> show-room-form  -> @set-room-form
      
      // ADD A ROOM
      @add-room-form    dom-on-submit
      @add-room-form -> eat-room-form
      @add-room-form -> {$game.rooms | count} -> room-changer

      // LIST EXISTS
      
      @over-exit dom-on-mouseover .exit-listing
      @out-exit  dom-on-mouseout  .exit-listing
      @tweak-style
      @over-exit -> {* (:id {("exit-" __in) | join} :attr "background-color" :value :yellow)} -> @tweak-style
      @out-exit  -> {* (:id {("exit-" __in) | join} :attr "background-color" :value :green)}  -> @tweak-style
    
      // ADD AN EXIT
      
      
      
      // EDIT AN EXIT

      // REMOVE AN EXIT
      
      
      
      
      
      // TODO: spots GUI
      // TODO: add 'parent' to history
      // TODO: munge html and daimio code in html templates separately (like {3 | >$x} -> {3 | &gt;x})
      // TODO: make run default to all local named scoped params (ORLY?) [could work for injected but not pipeline]
      // TODO: only run with not if with but maybe merge with stupid state stupid alias stupid pipes
      // YAGNI: local machine refs
      // YAGNI: whitespace chomping
      
  </script>


  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    D.import_port_flavour('tweak-style', {
      dir: 'out',
      outside_exit: function(ship) {
        try {
          var el = document.getElementById(ship.id)
          if(!el) return false

          el.style[ship.attr] = ship.value        
        } catch(e) {}
      }
    })
  
  
    document.addEventListener('DOMContentLoaded', function() {
      
      D.Etc.socket = io.connect('/')
      
      var template_els = [].slice.call(document.querySelectorAll('[data-daimio-template]'))
        , templates    = template_els.reduce(function(acc, template) {
                           var name = template.attributes.getNamedItem('data-daimio-template').value
                           acc[name] = template.innerHTML
                           template.innerHTML = ""
                           return acc
                         }, {})

      document.getElementsByTagName('body')[0].style.display = ''
                       
      var seedlikes = Array.prototype.slice.call(
                        document.getElementsByClassName('spaceseeds')
                      ).map(function(node) {
                        return node.text
                      }).join("\n")
      
      var outerseed = D.make_some_space(seedlikes, templates)
      OuterSpace = new D.Space(outerseed) // published for debug
      
      // activate init port
      var game_id = window.location.pathname.replace(/\/$/, '').split('/')[1]
      var data = {game: game_id} // {game: '5275ec64388d57ccb2f87d0e'}
      D.send_value_to_js_port(outerseed, 'init', data)
      
    })
  </script>

</body>
</html>